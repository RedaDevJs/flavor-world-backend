import multer from 'multer';
import { fileURLToPath } from 'url';
import { dirname, join, extname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        const ALLOWED_IMAGE = {
            'image/png': 'png',
            'image/jpeg': 'jpeg',
            'image/jpg': 'jpg',
        };

        let error = null;

        if (!ALLOWED_IMAGE[file.mimetype]) {
            error = new Error('FileError');
        } 

        cb(error, join(__dirname, '../public/assets/all-images/img-recipes'));
    },
    filename: function (req, file, cb) {
        const uniquePrefix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        const fileExtension = extname(file.originalname);
        cb(null, uniquePrefix + fileExtension);
    }
});

export default storage;
